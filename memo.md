# メモ

## 用語

- トランザクション
  - 暗号資産の送金記録のこと
- 署名（デジタル署名）
  - 秘密鍵を使って「この送金は本人が承認したもの」と証明する仕組み
  - 印鑑のデジタル版のようなもの
- ブロードキャスト
  - 作成したトランザクションをネットワーク（ブロックチェーン）に送信すること
- RLP (Recursive Length Prefix)
  - Ethereumで使われるデータシリアライゼーション形式。データ構造をバイト列に変換する仕組み。
  - シンプルで決定論的（同じデータは必ず同じバイト列になる）
  - 長さ情報を含む（Recursive Length Prefix）
  - バイナリ形式で効率的
  - エンコーディングルール
    - 1. 文字列（バイト列）の場合
      - データ長が0-55バイト: [長さ] + [データ]
      - データ長が56バイト以上: [183 + 長さの桁数] + [長さ] + [データ]
    - 2. 配列（リスト）の場合
      - 総長が0-55バイト: [192 + 総長] + [要素1のRLP] + [要素2のRLP] + ...
      - 総長が56バイト以上: [247 + 総長の桁数] + [総長] + [要素1のRLP] + ...
- Chain ID
  - mainnet, testnet ごとに固定（アカウントやサービスは関係なし）
  - mainnet は 1、 Sepolia は 11155111 のように決まっている。
- Recovery ID
  - 署名から元の公開鍵（≒アドレス）を復元するための追加情報
  - ECDSA署名だけでは、同じ署名値(r, s)から4つの異なる公開鍵が復元可能。このうち正しいのは一つだけで、「4つのうちどれが正しいか」を示す識別子（0, 1, 2, 3）のこと。
    - Recovery ID = 0: x座標が偶数、y座標が偶数
    - Recovery ID = 1: x座標が偶数、y座標が奇数  
    - Recovery ID = 2: x座標が奇数、y座標が偶数
    - Recovery ID = 3: x座標が奇数、y座標が奇数
  - トランザクションデータの `odd_y_parity` は公開鍵のy座標が奇数かどうかなので、 1, 3 の場合は true。
    - ちなみに奇数判定で `(x & 1) == 1` としているのは、 `(x % 2) == 1` は除算命令を使うため比較的重い処理になってしまう（最適化により `% 2` が `& 1` になる場合もある）。
    - 暗号化ライブラリでは `& 1` が一般的らしい。

## 調べたこと

- 技術選択：Bitcoin vs Ethereum
  - Ethereum のほうがライブラリが充実している。
  - Bitcoin はより基本的だが実装が複雑な場合もある。
  - Bitcoin と Ethereum とでは異なる実装が必要になる。今回は Ethereum 用に実装する。
    - Ethereum
      - トランザクション構造: 比較的シンプル（to, value, gas, gasPrice, nonce等）
      - 署名方式: ECDSA（secp256k1）+ Ethereum独自のフォーマット
      - ライブラリ: ethers、web3系が豊富
      - アドレス形式: 0x... で始まる40文字の16進数
    - Bitcoin
      - トランザクション構造: より複雑（UTXO、input/output、script等）
      - 署名方式: ECDSA + Bitcoin独自のフォーマット
      - ライブラリ: bitcoin、bitcoinjs-lib等
      - アドレス形式: 1...、3...、bc1... で始まる

以降、 Ethereum について

- 署名方式: ECDSA（secp256k1）
  - 楕円曲線デジタル署名アルゴリズムの一種
    - secp256k1: Bitcoinでも使われている楕円曲線のパラメータ
    - 署名の仕組み: 秘密鍵（256bit）から公開鍵を生成し、メッセージに対する署名を作成
    - 検証: 公開鍵と署名があれば、その署名が正しい秘密鍵で作られたか検証可能
- nonce: アカウントごとの取引シーケンス番号
  - 0から開始: 新しいアドレスの最初の取引はnonce=0
  - 連続性: 1, 2, 3... と順番に増加
  - 重複禁止: 同じnonceの取引は実行されない
- gas: Ethereum上での「燃料」の概念
  - gasLimit: ガス上限
    - 送金の場合: 通常21,000
    - スマートコントラクト: より多く必要（数十万〜数百万）
    - 意味: 「この取引に最大○○ガスまで使っていい」  
  - gasPrice: ガス価格
    - 単位: Gwei（1 Gwei = 0.000000001 ETH）
    - 相場: ネットワーク混雑状況で変動（10〜200+ Gwei）
    - 意味: 「1ガスあたり○○Gweiで支払う」
  - gas が必要な理由
    - スパム防止: 無料だと無限にトランザクションを送れてしまう
    - 計算量制御: 重い処理には多くのガスが必要
    - マイナーへの報酬: ガス料金がマイナーの収入になる
- ethereum クレート
  - 署名処理ではなくデータ構造体を提供している。
    - RLP エンコーディングなどの一部機能だけ提供されている。
  - トランザクションデータを表す構造体に `EIP1559Transaction` や `EIP2930Transaction` といったものがある。
    - これらはバージョンの違い。
    - Legacy (従来型) や EIP-1559, EIP-2930 で定義されたデータ型がある。
    - ガス価格の仕組みやアクセスリストの追加といった変更がある。今回は EIP-1559 の仕様に合わせて実装する。
      - EIP2930 (Type 0) ... EIP-3798 で非推奨
      - Legacy ... ガス価格の計算を自動ではやってくれないので、余分に支払ってしまうなどの問題がある。EIP-1559 等のデータ型に合わせようとすると大規模アップデートが必要になるため、まだ従来型で動いているところも多い。
  - `EIP1559Transaction` 構造体は odd_y_parity, r, s 値を持ってしまっており、署名前のハッシュ値計算には使えない
    - `EIP1559TransactionMessage` 構造体が正しい。
    - `EIP1559Transaction` 構造体は odd_y_parity, r, s 値を計算した後で使用する。
- `EIP1559TransactionMessage` 構造体の hash 関数の実装は EIP-2718 の仕様通り。このナンバリングが違う（1559, 2718）のは、 EIP-1559 ではデータ構造について、 EIP-2718 はハッシュ形式についての仕様となっているため。
  - EIP-2930 もハッシュ形式は EIP-2718 の仕様に基づいている。
  - EIP はその時々のすべての仕様を網羅しているわけではなく、データ構造やハッシュなどに分けて仕様が定義されており、またある EIP では過去の EIP をいくつかまとめた新しい方式（仕様）となることもある。
